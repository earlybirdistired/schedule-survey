<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì„¤ë¬¸ ê²°ê³¼ ìš”ì•½</title>

<style>
    body {
        font-family: 'Noto Sans KR', sans-serif;
        max-width: 900px;
        margin: 30px auto;
        padding: 20px;
        background: #f8f9fa;
    }
    h1 { text-align: center; margin-bottom: 30px; }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 25px;
        background: white;
        border-radius: 10px;
        overflow: hidden;
    }
    th, td {
        padding: 12px;
        border-bottom: 1px solid #ddd;
        text-align: center;
    }
    th { background: #4dabf7; color: white; }
    tr:hover { background: #e7f5ff; }

    #bestDates {
        background: #d0ebff;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    #myResult {
        background: #fff3bf;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        display: none;
    }

    #editBtn {
        background: #4dabf7;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        margin-top: 10px;
    }
</style>

</head>
<body>

<h1 id="title"></h1>

<!-- ë‚´ ì œì¶œ ì •ë³´ ë°•ìŠ¤ -->
<div id="myResult">
    <h2>ğŸ§‘ ë‚´ ì œì¶œ ì •ë³´</h2>
    <p id="myInfo"></p>
    <p id="myDates"></p>
    <button id="editBtn">âœ ìˆ˜ì •í•˜ê¸°</button>
</div>

<div id="bestDates">
    <h2>ğŸ“Œ ìµœì  ë‚ ì§œ ì¶”ì²œ</h2>
    <ul id="bestList"></ul>
</div>

<h2>ğŸ“… ë‚ ì§œë³„ ìš”ì•½</h2>
<table>
    <thead>
        <tr>
            <th>ë‚ ì§œ</th>
            <th>ê°€ëŠ¥</th>
            <th>ì• ë§¤</th>
            <th>ë¶ˆê°€ëŠ¥</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script>
// Supabase ì„¤ì •
const supabaseUrl = "https://izymighgwabdngivowbb.supabase.co";
const apiKey = "sb_publishable_gnrYgb7L41g1RT2aEx0k6A_9irp_998";

// URL íŒŒë¼ë¯¸í„°
const params = new URLSearchParams(window.location.search);
const title = params.get("title");
const token = params.get("token");

document.getElementById("title").innerText = title + " ì„¤ë¬¸ ê²°ê³¼";

// UI ìš”ì†Œ
const myResultBox = document.getElementById("myResult");
const myInfoBox = document.getElementById("myInfo");
const myDatesBox = document.getElementById("myDates");
const editBtn = document.getElementById("editBtn");

// 1) ì „ì²´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
async function loadAll() {
    const res = await fetch(
        `${supabaseUrl}/rest/v1/surveys?title=eq.${encodeURIComponent(title)}`, {
            headers: { apikey: apiKey, Authorization: "Bearer " + apiKey }
        }
    );
    return res.json();
}

// 2) ë‚´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
async function loadMyData() {
    if (!token) return null;

    const res = await fetch(
        `${supabaseUrl}/rest/v1/surveys?title=eq.${encodeURIComponent(title)}&participant_token=eq.${token}`,
        { headers: { apikey: apiKey, Authorization: "Bearer " + apiKey } }
    );
    return res.json();
}

async function start() {
    const allRows = await loadAll();
    summarize(allRows);

    const myRows = await loadMyData();

    // token ìˆì„ ë•Œë§Œ í‘œì‹œ
    if (myRows && myRows.length > 0) {
        const name = myRows[0].name;

        myInfoBox.innerHTML = `<b>${name}</b>ë‹˜ì´ ì œì¶œí•œ ê²°ê³¼ì…ë‹ˆë‹¤.`;

        // ë‚ ì§œ ìš”ì•½ êµ¬ì„±
        const dateList = myRows
            .map(r => `${r.date} â†’ ${r.status}`)
            .join("<br>");

        myDatesBox.innerHTML = dateList;

        myResultBox.style.display = "block";

        // ìˆ˜ì •í•˜ê¸° ë²„íŠ¼
        editBtn.onclick = () => {
            window.location.href = `survey.html?title=${encodeURIComponent(title)}&token=${token}`;
        };
    }
}

// ë‚ ì§œë³„ ìš”ì•½ + ì¶”ì²œ ë‚ ì§œ
function summarize(rows) {
    const summary = {};

    rows.forEach(r => {
        if (!summary[r.date]) summary[r.date] = { available: 0, maybe: 0, unavailable: 0 };
        if (r.status === "ê°€ëŠ¥") summary[r.date].available++;
        if (r.status === "ì• ë§¤í•¨") summary[r.date].maybe++;
        if (r.status === "ë¶ˆê°€ëŠ¥") summary[r.date].unavailable++;
    });

    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    Object.keys(summary).sort().forEach(date => {
        const s = summary[date];
        tbody.innerHTML += `
            <tr>
                <td>${date}</td>
                <td>${s.available}</td>
                <td>${s.maybe}</td>
                <td>${s.unavailable}</td>
            </tr>`;
    });

    const scored = Object.keys(summary).map(date => {
        const s = summary[date];
        const score = s.available * 2 - s.unavailable * 100;
        return { date, score };
    }).sort((a, b) => b.score - a.score);

    document.getElementById("bestList").innerHTML =
        scored.slice(0, 3).map(item => `<li>${item.date} (ì ìˆ˜: ${item.score})</li>`).join("");
}

start();
</script>

</body>
</html>
