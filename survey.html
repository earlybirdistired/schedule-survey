<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì•½ì† ì„¤ë¬¸</title>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            max-width: 700px;
            margin: 30px auto;
            padding: 20px;
            background: #f8f9fa;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        button {
            width: 100%;
            padding: 15px;
            background: #4dabf7;
            color: white;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 30px;
        }
        button:hover {
            background: #339af0;
        }

        #calendarBox {
            background: white;
            padding: 18px;
            border-radius: 12px;
            margin-top: 30px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .day {
            background: white;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            border: 1px solid #ddd;
            user-select: none;
            transition: 0.2s;
        }

        .day:hover {
            transform: scale(1.05);
        }

        .available { background: #b2f2bb !important; }
        .unavailable { background: #ff8787 !important; }
        .maybe { background: #ffe066 !important; }

        #modeButtons {
            margin-top: 20px;
            text-align: center;
        }

        .modeBtn {
            padding: 10px 12px;
            margin: 4px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            cursor: pointer;
        }

        .modeBtn.active {
            outline: 3px solid #228be6;
        }
    </style>
</head>

<body>

<h1 id="titleDisplay">ì•½ì† ì„¤ë¬¸</h1>

<!-- ì´ë¦„ ì…ë ¥ -->
<div style="margin-top: 20px;">
    <h2>â‘  ì´ë¦„</h2>
    <input type="text" id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
</div>

<!-- ì—¬í–‰ì§€ ì…ë ¥ -->
<div style="margin-top: 30px;">
    <h2>â‘¡ ê°€ê³  ì‹¶ì€ ì—¬í–‰ì§€</h2>
    <input type="text" id="destination" placeholder="ì˜ˆ: ë‚¨í•´, ì œì£¼ë„">
    <br><br>
    <label>
        <input type="checkbox" id="no_destination"> ê°€ê³  ì‹¶ì€ ì—¬í–‰ì§€ê°€ ì—†ì–´ìš” (X)
    </label>
</div>

<!-- ì„ íƒ ëª¨ë“œ ë²„íŠ¼ -->
<div id="modeButtons">
    <button type="button" class="modeBtn active" data-mode="ê°€ëŠ¥" style="background:#b2f2bb;">ê°€ëŠ¥</button>
    <button type="button" class="modeBtn" data-mode="ë¶ˆê°€ëŠ¥" style="background:#ff8787;">ë¶ˆê°€ëŠ¥</button>
    <button type="button" class="modeBtn" data-mode="ì• ë§¤í•¨" style="background:#ffe066;">ì• ë§¤</button>
    <button type="button" class="modeBtn" data-mode="none" style="background:#dee2e6;">ì§€ìš°ê¸°</button>
</div>

<!-- ë‹¬ë ¥ -->
<div id="calendarBox">
    <h2 id="monthTitle"></h2>
    <p>ë‚ ì§œ í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸ â†’ <b>ê°€ëŠ¥ / ë¶ˆê°€ëŠ¥ / ì• ë§¤ / ì§€ìš°ê¸°</b></p>
    <div class="calendar" id="calendar"></div>
</div>

<button onclick="submitSurvey()">ì œì¶œí•˜ê¸°</button>

<script>
// --------------------------------------------------
// ì œëª© íŒŒë¼ë¯¸í„° ë¶ˆëŸ¬ì˜¤ê¸°
// --------------------------------------------------
const params = new URLSearchParams(window.location.search);
const rawTitle = params.get("title");
const cleanTitle = rawTitle ? decodeURIComponent(rawTitle) : "ì œëª© ì—†ìŒ";

document.getElementById("titleDisplay").innerText = cleanTitle + " ì„¤ë¬¸";

// --------------------------------------------------
// ë‹¬ë ¥ ìƒì„±
// --------------------------------------------------
const calendarEl = document.getElementById("calendar");

const today = new Date();
const year = today.getFullYear();
const month = today.getMonth();

const monthNames = [
    "1ì›”","2ì›”","3ì›”","4ì›”","5ì›”","6ì›”",
    "7ì›”","8ì›”","9ì›”","10ì›”","11ì›”","12ì›”"
];
document.getElementById("monthTitle").innerText = `${year}ë…„ ${monthNames[month]}`;

const firstDay = new Date(year, month, 1).getDay();
const lastDate = new Date(year, month + 1, 0).getDate();

let dayStatus = {};

for (let i = 0; i < firstDay; i++) {
    calendarEl.appendChild(document.createElement("div"));
}

for (let d = 1; d <= lastDate; d++) {
    const cell = document.createElement("div");
    cell.className = "day";
    cell.innerText = d;

    const key = `${year}-${month + 1}-${d}`;
    cell.dataset.date = key;
    dayStatus[key] = "none";

    calendarEl.appendChild(cell);
}

// --------------------------------------------------
// ì„ íƒ ëª¨ë“œ ë²„íŠ¼
// --------------------------------------------------
let currentMode = "ê°€ëŠ¥";

document.querySelectorAll(".modeBtn").forEach(btn => {
    btn.addEventListener("click", () => {
        currentMode = btn.dataset.mode;
        document.querySelectorAll(".modeBtn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
    });
});

// --------------------------------------------------
// ë‚ ì§œ í´ë¦­ ë° ë“œë˜ê·¸ ì„ íƒ
// --------------------------------------------------
let isDragging = false;

function updateCell(cell, mode) {
    cell.classList.remove("available","unavailable","maybe");

    if (mode === "ê°€ëŠ¥") cell.classList.add("available");
    if (mode === "ë¶ˆê°€ëŠ¥") cell.classList.add("unavailable");
    if (mode === "ì• ë§¤í•¨") cell.classList.add("maybe");

    dayStatus[cell.dataset.date] = mode;
}

calendarEl.addEventListener("mousedown", e => {
    if (e.target.classList.contains("day")) {
        isDragging = true;
        updateCell(e.target, currentMode);
    }
});
calendarEl.addEventListener("mousemove", e => {
    if (isDragging && e.target.classList.contains("day")) {
        updateCell(e.target, currentMode);
    }
});
document.addEventListener("mouseup", () => isDragging = false);

calendarEl.addEventListener("touchstart", e => {
    isDragging = true;
    markTouch(e);
});
calendarEl.addEventListener("touchmove", e => {
    if (isDragging) markTouch(e);
});
calendarEl.addEventListener("touchend", () => isDragging = false);

function markTouch(e) {
    const touch = e.touches[0];
    const elem = document.elementFromPoint(touch.clientX, touch.clientY);
    if (elem && elem.classList.contains("day")) {
        updateCell(elem, currentMode);
    }
}

// --------------------------------------------------
// Supabase ì €ì¥ ê¸°ëŠ¥
// --------------------------------------------------
function submitSurvey() {
    const name = document.getElementById("name").value.trim();
    const destination = document.getElementById("destination").value.trim();
    const no_destination = document.getElementById("no_destination").checked ? "X" : "";

    if (!name) {
        alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
    }

    const data = {
        title: cleanTitle,
        name,
        date_available: dayStatus,
        destination,
        no_destination
    };

    console.log("[ì œì¶œ ë°ì´í„°]", data);

    fetch("https://izymighgwabdngivowbb.supabase.co/rest/v1/surveys", {
        method: "POST",
        headers: {
            "apikey": "sb_publishable_gnrYgb7L41g1RT2aEx0k6A_9irp_998",
            "Authorization": "Bearer sb_publishable_gnrYgb7L41g1RT2aEx0k6A_9irp_998",
            "Content-Type": "application/json",
            "Prefer": "return=minimal"
        },
        body: JSON.stringify(data)
    })
    .then(res => {
        if (res.ok) {
            alert("ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ˜Š");
        } else {
            alert("ì €ì¥ ì‹¤íŒ¨: " + res.status);
        }
    })
    .catch(err => {
        console.error(err);
        alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    });
}
</script>

</body>
</html>
