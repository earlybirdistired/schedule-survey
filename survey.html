<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>약속 설문</title>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            max-width: 700px;
            margin: 30px auto;
            padding: 20px;
            background: #f8f9fa;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        button {
            width: 100%;
            padding: 15px;
            background: #4dabf7;
            color: white;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 30px;
        }
        button:hover {
            background: #339af0;
        }

        #calendarBox {
            background: white;
            padding: 18px;
            border-radius: 12px;
            margin-top: 30px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .day {
            background: white;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            border: 1px solid #ddd;
            user-select: none;
            transition: 0.2s;
        }

        .day:hover {
            transform: scale(1.05);
        }

        .available { background: #b2f2bb !important; }
        .unavailable { background: #ff8787 !important; }
        .maybe { background: #ffe066 !important; }

        #modeButtons {
            margin-top: 20px;
            text-align: center;
        }

        .modeBtn {
            padding: 10px 12px;
            margin: 4px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            cursor: pointer;
        }

        .modeBtn.active {
            outline: 3px solid #228be6;
        }
    </style>
</head>

<body>

<h1 id="titleDisplay">약속 설문</h1>

<!-- 이름 입력 -->
<div style="margin-top: 20px;">
    <h2>① 이름</h2>
    <input type="text" id="name" placeholder="이름을 입력하세요">
</div>

<!-- 여행지 입력 -->
<div style="margin-top: 30px;">
    <h2>② 가고 싶은 여행지</h2>
    <input type="text" id="destination" placeholder="예: 남해, 제주도">
    <br><br>
    <label>
        <input type="checkbox" id="no_destination"> 가고 싶은 여행지가 없어요 (X)
    </label>
</div>

<!-- 선택 모드 버튼 -->
<div id="modeButtons">
    <button type="button" class="modeBtn active" data-mode="가능" style="background:#b2f2bb;">가능</button>
    <button type="button" class="modeBtn" data-mode="불가능" style="background:#ff8787;">불가능</button>
    <button type="button" class="modeBtn" data-mode="애매함" style="background:#ffe066;">애매</button>
    <button type="button" class="modeBtn" data-mode="none" style="background:#dee2e6;">지우기</button>
</div>

<!-- 달력 -->
<div id="calendarBox">
    <h2 id="monthTitle"></h2>
    <p>날짜 클릭 또는 드래그 → <b>가능 / 불가능 / 애매 / 지우기</b></p>
    <div class="calendar" id="calendar"></div>
</div>

<button onclick="submitSurvey()">제출하기</button>

<script>
// --------------------------------------------------
// 제목 파라미터 불러오기
// --------------------------------------------------
const params = new URLSearchParams(window.location.search);
const rawTitle = params.get("title");
const cleanTitle = rawTitle ? decodeURIComponent(rawTitle) : "제목 없음";

document.getElementById("titleDisplay").innerText = cleanTitle + " 설문";

// --------------------------------------------------
// 달력 생성
// --------------------------------------------------
const calendarEl = document.getElementById("calendar");

const today = new Date();
const year = today.getFullYear();
const month = today.getMonth();

const monthNames = [
    "1월","2월","3월","4월","5월","6월",
    "7월","8월","9월","10월","11월","12월"
];
document.getElementById("monthTitle").innerText = `${year}년 ${monthNames[month]}`;

const firstDay = new Date(year, month, 1).getDay();
const lastDate = new Date(year, month + 1, 0).getDate();

let dayStatus = {};

for (let i = 0; i < firstDay; i++) {
    calendarEl.appendChild(document.createElement("div"));
}

for (let d = 1; d <= lastDate; d++) {
    const cell = document.createElement("div");
    cell.className = "day";
    cell.innerText = d;

    const key = `${year}-${month + 1}-${d}`;
    cell.dataset.date = key;
    dayStatus[key] = "none";

    calendarEl.appendChild(cell);
}

// --------------------------------------------------
// 선택 모드 버튼
// --------------------------------------------------
let currentMode = "가능";

document.querySelectorAll(".modeBtn").forEach(btn => {
    btn.addEventListener("click", () => {
        currentMode = btn.dataset.mode;
        document.querySelectorAll(".modeBtn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
    });
});

// --------------------------------------------------
// 날짜 클릭 및 드래그 선택
// --------------------------------------------------
let isDragging = false;

function updateCell(cell, mode) {

    // 색 초기화
    cell.classList.remove("available", "unavailable", "maybe");

    // 상태 적용
    if (mode === "가능") cell.classList.add("available");
    if (mode === "불가능") cell.classList.add("unavailable");
    if (mode === "애매함") cell.classList.add("maybe");

    // ⭐ 중요: dayStatus를 정확히 저장
    if (mode === "none") {
        dayStatus[cell.dataset.date] = "none";
    } else {
        dayStatus[cell.dataset.date] = mode;
    }
}

calendarEl.addEventListener("mousedown", e => {
    if (e.target.classList.contains("day")) {
        isDragging = true;
        updateCell(e.target, currentMode);
    }
});
calendarEl.addEventListener("mousemove", e => {
    if (isDragging && e.target.classList.contains("day")) {
        updateCell(e.target, currentMode);
    }
});
document.addEventListener("mouseup", () => isDragging = false);

calendarEl.addEventListener("touchstart", e => {
    isDragging = true;
    markTouch(e);
});
calendarEl.addEventListener("touchmove", e => {
    if (isDragging) markTouch(e);
});
calendarEl.addEventListener("touchend", () => isDragging = false);

function markTouch(e) {
    const touch = e.touches[0];
    const elem = document.elementFromPoint(touch.clientX, touch.clientY);
    if (elem && elem.classList.contains("day")) {
        updateCell(elem, currentMode);
    }
}

// --------------------------------------------------
// Supabase 저장 기능
// --------------------------------------------------
function submitSurvey() {
    const name = document.getElementById("name").value.trim();
    const destination = document.getElementById("destination").value.trim();
    const no_destination = document.getElementById("no_destination").checked ? "X" : "";

    if (!name) {
        alert("이름을 입력해주세요!");
        return;
    }

    const data = {
        title: cleanTitle,
        name,
        date_available: dayStatus,   // JSON OK
        destination,
        no_destination
    };

    console.log("[제출 데이터]", data);

    fetch("https://izymighgwabdngivowbb.supabase.co/rest/v1/surveys", {
        method: "POST",
        headers: {
            "apikey": "sb_publishable_gnrYgb7L41g1RT2aEx0k6A_9irp_998",
            "Authorization": "Bearer sb_publishable_gnrYgb7L41g1RT2aEx0k6A_9irp_998",
            "Content-Type": "application/json",
            "Prefer": "return=minimal"
        },
        body: JSON.stringify(data)
    })
    .then(res => {
        if (res.ok) {
            alert("제출 완료!");
        } else {
            return res.text().then(msg => {
                alert("저장 실패: " + res.status + "\n" + msg);
                console.error(msg);
            });
        }
    })
    .catch(err => {
        console.error(err);
        alert("오류 발생: " + err);
    });
}
</script>

</body>
</html>


